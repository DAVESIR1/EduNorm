rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- HELPER FUNCTIONS ---
    
    // Check if user is authenticated
    function isAuth() {
      return request.auth != null;
    }

    // Check if user is Admin (Hardcoded for safety, ideally use Custom Claims)
    function isAdmin() {
      return isAuth() && (
        request.auth.token.email == 'baraiyanitin220@gmail.com' ||
        request.auth.token.phone_number == '+919737970647'
      );
    }

    // Check if the user accessing their own profile
    function isOwner(userId) {
      return isAuth() && request.auth.uid == userId;
    }

    // --- RULES ---

    // 1. SCHOOLS COLLECTION
    // Public Read: Required for "School Code Verification" check.
    // Write: Admin OR the school owner (Auth UID == schoolId)
    // This is critical for publishToPublicDirectory and MigrationService to work!
    match /schools/{schoolId} {
      allow read: if true;
      allow write: if isAdmin() || isOwner(schoolId);

      // 2. STUDENTS SUBCOLLECTION
      // Read: Any authenticated user (for student verification)
      // Write: Admin OR school owner
      match /students/{studentId} {
        allow read: if isAuth() || (request.query.limit <= 1);
        allow write: if isAdmin() || isOwner(schoolId);
      }

      // 3. TEACHERS SUBCOLLECTION
      match /teachers/{teacherId} {
        allow read: if isAuth();
        allow write: if isAdmin() || isOwner(schoolId);
      }
    }

    // 4. USER PROFILES
    // Strict Owner Access: Users can only read/write their own profile.
    match /users/{userId} {
      allow read, write: if isOwner(userId);
    }

    // 5. SETTINGS / GLOBAL CONFIG
    match /settings/{docId} {
      allow read: if true; // Public settings like "Maintenance Mode"
      allow write: if isAdmin();
    }

    // 5.5 BACKUPS COLLECTION (Recurisve access for chunks, history, etc.)
    match /backups/{userId} {
      allow read, write: if isOwner(userId);
      
      match /{document=**} {
        allow read, write: if isOwner(userId);
      }
    }

    // 5.6 ADMIN BACKUPS (For redundancy)
    match /admin-backups/{userId}/{document=**} {
      allow create: if isOwner(userId); // Allow users to push their auto-backup
      allow read, write: if isAdmin();
    }

    // 6. BUG REPORTS (Allow users to report, Admin to manage)
    match /admin_bugs/{bugId} {
      allow create: if isAuth();
      allow read, delete, update: if isAdmin();
    }

    // 6. SCHOOL PROFILE (Fix for "Missing Permissions" error)
    // Allow authenticated users (Admins/HOIs) to manage their school profile
    match /schoolProfile/{document=**} {
      allow read, write: if isAuth(); 
    }
    
    // Default Deny
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
